/**
 * Markdown report formatter.
 * Produces the same detailed content as the text report but with proper markdown formatting.
 */

import { formatDuration, formatTimestamp, computeProjectStats, computeTotalDurationMs, getNewCodePeriodSkippedProjects } from './shared.js';

/**
 * Format results as a markdown report.
 */
export function formatMarkdownReport(results) {
  const sections = [];

  sections.push(formatHeader(results));
  sections.push(formatSummary(results));
  sections.push(formatKeyConflicts(results));
  sections.push(formatNewCodePeriodWarnings(results));
  sections.push(formatServerSteps(results));
  sections.push(formatOrgResults(results));
  sections.push(formatProblemProjects(results));
  sections.push(formatAllProjects(results));

  sections.push('---\n*Generated by CloudVoyager*\n');

  return sections.filter(Boolean).join('\n');
}

function formatHeader(results) {
  const lines = ['# CloudVoyager Migration Report\n'];
  lines.push(`**Started:** ${formatTimestamp(results.startTime) || results.startTime}  `);
  lines.push(`**Finished:** ${formatTimestamp(results.endTime) || 'In progress'}  `);

  const durationMs = computeTotalDurationMs(results);
  if (durationMs != null) {
    lines.push(`**Duration:** ${formatDuration(durationMs)}  `);
  }
  if (results.dryRun) {
    lines.push('**Mode:** DRY RUN (no data migrated)  ');
  }
  lines.push('');
  return lines.join('\n');
}

function formatSummary(results) {
  const { succeeded, partial, failed, total } = computeProjectStats(results);
  const projectLine = total > 0
    ? `${succeeded} succeeded, ${partial} partial, ${failed} failed (${total} total)`
    : '0 (no projects migrated)';

  const lines = [
    '## Summary\n',
    '| Resource | Result |',
    '|----------|--------|',
    `| Projects | ${projectLine} |`,
    `| Quality Gates | ${results.qualityGates} migrated |`,
    `| Quality Profiles | ${results.qualityProfiles} migrated |`,
    `| Groups | ${results.groups} created |`,
    `| Portfolios | ${results.portfolios} created |`,
    `| Issues | ${results.issueSyncStats.matched} matched, ${results.issueSyncStats.transitioned} transitioned |`,
    `| Hotspots | ${results.hotspotSyncStats.matched} matched, ${results.hotspotSyncStats.statusChanged} status changed |`,
    '',
  ];
  return lines.join('\n');
}

function formatKeyConflicts(results) {
  const keyWarnings = results.projectKeyWarnings || [];
  if (keyWarnings.length === 0) return null;

  const lines = [
    '## Project Key Conflicts\n',
    `> **${keyWarnings.length} project(s)** could not use the original SonarQube key because the key is already taken by another organization on SonarCloud. The migration tool falls back to a prefixed key (\`{org}_{key}\`).\n`,
    '| SonarQube Key | SonarCloud Key | Taken By |',
    '|---------------|----------------|----------|',
  ];
  for (const w of keyWarnings) {
    lines.push(`| \`${w.sqKey}\` | \`${w.scKey}\` | ${w.owner} |`);
  }
  lines.push('');
  return lines.join('\n');
}

function formatNewCodePeriodWarnings(results) {
  const ncpSkipped = getNewCodePeriodSkippedProjects(results);
  if (ncpSkipped.length === 0) return null;

  const lines = [
    '## New Code Period Not Set\n',
    `> **${ncpSkipped.length} project(s)** use unsupported new code period types (e.g. \`REFERENCE_BRANCH\`) that cannot be migrated to SonarCloud. Please configure these manually.\n`,
    '| Project | Reason |',
    '|---------|--------|',
  ];
  for (const { projectKey, detail } of ncpSkipped) {
    lines.push(`| \`${projectKey}\` | ${detail} |`);
  }
  lines.push('');
  return lines.join('\n');
}

function statusIcon(status) {
  if (status === 'success') return 'OK';
  if (status === 'failed') return 'FAIL';
  if (status === 'skipped') return 'SKIP';
  return status;
}

function formatServerSteps(results) {
  if (results.serverSteps.length === 0) return null;

  const lines = [
    '## Server-Wide Steps\n',
    '| Step | Status | Detail |',
    '|------|--------|--------|',
  ];
  for (const step of results.serverSteps) {
    const detail = step.detail || step.error || '';
    lines.push(`| ${step.step} | ${statusIcon(step.status)} | ${detail} |`);
  }
  lines.push('');
  return lines.join('\n');
}

function formatOrgResults(results) {
  if (!results.orgResults || results.orgResults.length === 0) return null;

  const sections = [];
  for (const org of results.orgResults) {
    const lines = [
      `## Organization: ${org.key} (${org.projectCount} projects)\n`,
      '| Step | Status | Detail |',
      '|------|--------|--------|',
    ];
    for (const step of (org.steps || [])) {
      const detail = step.detail || step.error || '';
      lines.push(`| ${step.step} | ${statusIcon(step.status)} | ${detail} |`);
    }
    lines.push('');
    sections.push(lines.join('\n'));
  }
  return sections.join('\n');
}

function formatProblemProjects(results) {
  const problemProjects = results.projects.filter(p => p.status !== 'success');
  if (problemProjects.length === 0) return null;

  const sections = ['## Failed / Partial Projects\n'];

  for (const project of problemProjects) {
    const statusLabel = project.status === 'failed' ? 'FAIL' : 'PARTIAL';
    sections.push(`### [${statusLabel}] ${project.projectKey}\n`);
    sections.push(`**SonarCloud key:** \`${project.scProjectKey}\`\n`);

    const lines = [
      '| Step | Status | Detail |',
      '|------|--------|--------|',
    ];
    for (const step of project.steps) {
      const detail = step.error || step.detail || '';
      lines.push(`| ${step.step} | ${statusIcon(step.status)} | ${detail} |`);
    }
    lines.push('');
    sections.push(lines.join('\n'));
  }
  return sections.join('\n');
}

function formatAllProjects(results) {
  if (results.projects.length === 0) return null;

  const lines = [
    '## All Projects\n',
    '| # | Project Key | Status | Failed Steps |',
    '|---|-------------|--------|-------------|',
  ];

  results.projects.forEach((project, i) => {
    const failedSteps = project.steps.filter(s => s.status === 'failed');
    const failedList = failedSteps.length > 0
      ? failedSteps.map(s => s.step).join(', ')
      : '';
    const status = project.status === 'success' ? 'OK' : project.status === 'partial' ? 'PARTIAL' : 'FAIL';
    lines.push(`| ${i + 1} | \`${project.projectKey}\` | ${status} | ${failedList} |`);
  });

  lines.push('');
  return lines.join('\n');
}
