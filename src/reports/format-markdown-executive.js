/**
 * Executive Summary markdown formatter.
 * Produces a concise (~1 page) report aimed at engineering leadership.
 */

import { formatDuration, formatTimestamp, computeProjectStats, computeOverallStatus, computeTotalDurationMs, getNewCodePeriodSkippedProjects, formatNumber, computeTotalLoc, computeLocThroughput } from './shared.js';

/**
 * Format results as an executive summary in markdown.
 */
export function formatExecutiveSummaryMarkdown(results) {
  const sections = [];
  const stats = computeProjectStats(results);
  const overallStatus = computeOverallStatus(stats);
  const durationMs = computeTotalDurationMs(results);

  sections.push(formatHeader(results, durationMs));
  sections.push(formatOverallStatus(stats, overallStatus));
  sections.push(formatKeyMetrics(results, stats));
  sections.push(formatWarningsAndRisks(results, stats));
  sections.push(formatActionItems(results, stats));
  sections.push(formatFailedProjects(results));
  sections.push('---\n*Generated by CloudVoyager*\n');

  return sections.filter(Boolean).join('\n');
}

function formatHeader(results, durationMs) {
  const date = formatTimestamp(results.startTime) || 'Unknown';

  const lines = ['# CloudVoyager Migration â€” Executive Summary\n'];
  lines.push(`**Date:** ${date}  `);
  if (durationMs != null) {
    lines.push(`**Duration:** ${formatDuration(durationMs)}  `);
  }
  if (results.dryRun) {
    lines.push('**Mode:** DRY RUN (no data migrated)  ');
  }
  const orgCount = (results.orgResults || []).length;
  if (orgCount > 0) {
    lines.push(`**Target Organizations:** ${orgCount}  `);
  }
  lines.push('');
  return lines.join('\n');
}

function formatOverallStatus(stats, overallStatus) {
  const successRate = stats.total > 0
    ? ((stats.succeeded / stats.total) * 100).toFixed(1)
    : '0.0';

  const lines = [`## Overall Status: ${overallStatus}\n`];

  if (stats.total === 0) {
    lines.push('No projects were migrated.\n');
  } else if (stats.failed === 0 && stats.partial === 0) {
    lines.push(`Migration of **${stats.total} project(s)** completed with a **${successRate}% success rate**.\n`);
  } else {
    lines.push(`Migration of **${stats.total} project(s)** completed with **${stats.succeeded} fully migrated** (${successRate}% success rate).\n`);
    if (stats.partial > 0) {
      lines.push(`- ${stats.partial} project(s) partially migrated (some steps failed)`);
    }
    if (stats.failed > 0) {
      lines.push(`- ${stats.failed} project(s) failed entirely`);
    }
    lines.push('');
  }

  return lines.join('\n');
}

function formatKeyMetrics(results, stats) {
  const lines = [
    '## Key Metrics\n',
    '| Metric | Value |',
    '|--------|-------|',
    `| Total Projects | ${stats.total} |`,
    `| Fully Migrated | ${stats.succeeded} (${stats.total > 0 ? ((stats.succeeded / stats.total) * 100).toFixed(1) : 0}%) |`,
    `| Partially Migrated | ${stats.partial} (${stats.total > 0 ? ((stats.partial / stats.total) * 100).toFixed(1) : 0}%) |`,
    `| Failed | ${stats.failed} (${stats.total > 0 ? ((stats.failed / stats.total) * 100).toFixed(1) : 0}%) |`,
    `| Quality Profiles Migrated | ${results.qualityProfiles} |`,
    `| Quality Gates Migrated | ${results.qualityGates} |`,
    `| Groups Created | ${results.groups} |`,
    `| Portfolios Created | ${results.portfolios} |`,
    `| Issues Synced | ${results.issueSyncStats.matched} matched, ${results.issueSyncStats.transitioned} transitioned |`,
    `| Hotspots Synced | ${results.hotspotSyncStats.matched} matched, ${results.hotspotSyncStats.statusChanged} status changed |`,
  ];
  const totalLoc = computeTotalLoc(results);
  if (totalLoc > 0) {
    lines.push(`| Total Lines of Code | ${formatNumber(totalLoc)} |`);
    const throughput = computeLocThroughput(results);
    if (throughput.locPerMinute != null) {
      lines.push(`| Migration Throughput | ${formatNumber(throughput.locPerMinute)} LOC/min |`);
    }
  }
  lines.push('');
  return lines.join('\n');
}

function formatWarningsAndRisks(results, stats) {
  const keyWarnings = results.projectKeyWarnings || [];
  const ncpSkipped = getNewCodePeriodSkippedProjects(results);

  if (keyWarnings.length === 0 && ncpSkipped.length === 0 && stats.failed === 0) {
    return '## Warnings & Risks\n\nNo warnings or risks identified.\n';
  }

  const lines = ['## Warnings & Risks\n'];

  if (keyWarnings.length > 0) {
    lines.push('### Project Key Conflicts\n');
    lines.push(`**${keyWarnings.length} project(s)** required a renamed key on SonarCloud due to global key conflicts. This may affect CI/CD pipeline configurations that reference the original project key.\n`);
  }

  if (ncpSkipped.length > 0) {
    lines.push('### New Code Period Configuration\n');
    lines.push(`**${ncpSkipped.length} project(s)** have unsupported new code period types (e.g. \`REFERENCE_BRANCH\`) and require manual configuration in SonarCloud.\n`);
  }

  if (stats.failed > 0) {
    lines.push('### Failed Projects\n');
    lines.push(`**${stats.failed} project(s)** failed to migrate entirely. Review the detailed migration report for root cause analysis.\n`);
  }

  if (stats.partial > 0) {
    lines.push('### Partially Migrated Projects\n');
    lines.push(`**${stats.partial} project(s)** had one or more steps fail. These projects may need manual intervention to complete migration.\n`);
  }

  return lines.join('\n');
}

function formatActionItems(results, stats) {
  const keyWarnings = results.projectKeyWarnings || [];
  const ncpSkipped = getNewCodePeriodSkippedProjects(results);
  const items = [];

  if (keyWarnings.length > 0) {
    items.push(`- [ ] Update CI/CD pipelines for renamed project keys (${keyWarnings.length} project(s))`);
  }
  if (ncpSkipped.length > 0) {
    items.push(`- [ ] Manually configure new code periods in SonarCloud (${ncpSkipped.length} project(s))`);
  }
  if (stats.failed > 0) {
    items.push(`- [ ] Investigate and retry failed project migrations (${stats.failed} project(s))`);
  }
  if (stats.partial > 0) {
    items.push(`- [ ] Review partially migrated projects and fix failed steps (${stats.partial} project(s))`);
  }
  items.push('- [ ] Review quality profile rule gaps in `quality-profiles/quality-profile-diff.json`');
  items.push('- [ ] Verify project permissions in SonarCloud dashboard');

  const lines = ['## Action Items\n', ...items, ''];
  return lines.join('\n');
}

function formatFailedProjects(results) {
  const failedProjects = results.projects.filter(p => p.status === 'failed');
  if (failedProjects.length === 0) return null;

  const lines = [
    '## Failed Projects\n',
    '| Project Key | Failed Steps |',
    '|-------------|-------------|',
  ];
  for (const project of failedProjects) {
    const failedSteps = project.steps.filter(s => s.status === 'failed');
    lines.push(`| \`${project.projectKey}\` | ${failedSteps.map(s => s.step).join(', ')} |`);
  }
  lines.push('');
  return lines.join('\n');
}
