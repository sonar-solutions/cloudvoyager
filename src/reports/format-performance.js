import { formatDuration, computeTotalDurationMs } from './shared.js';
import { sumDurations, getStepDuration, getConfigDuration, formatSlowestSteps, formatBottleneckAnalysis } from './perf-tables.js';

export function formatPerformanceReport(results) {
  const sections = [];
  sections.push(formatHeader(results));
  sections.push(formatOverview(results));
  sections.push(formatServerSteps(results));
  sections.push(formatOrgSteps(results));
  sections.push(formatProjectBreakdown(results));
  sections.push(formatSlowestSteps(results));
  sections.push(formatBottleneckAnalysis(results));
  sections.push('---\n*Generated by CloudVoyager*\n');
  return sections.filter(Boolean).join('\n');
}

function formatHeader(results) {
  const durationMs = computeTotalDurationMs(results);
  const lines = ['# CloudVoyager Migration — Performance Report\n'];
  lines.push(`**Started:** ${results.startTime}  `);
  lines.push(`**Finished:** ${results.endTime || 'In progress'}  `);
  if (durationMs != null) {
    lines.push(`**Total Duration:** ${formatDuration(durationMs)}  `);
  }
  lines.push('');
  return lines.join('\n');
}

function formatOverview(results) {
  const durationMs = computeTotalDurationMs(results);
  const projectCount = results.projects.length;
  const avgPerProject = projectCount > 0 && durationMs != null
    ? formatDuration(Math.round(durationMs / projectCount))
    : '—';
  const lines = [
    '## Overview\n',
    '| Metric | Value |',
    '|--------|-------|',
    `| Total Duration | ${durationMs != null ? formatDuration(durationMs) : '—'} |`,
    `| Projects Migrated | ${projectCount} |`,
    `| Average Time per Project | ${avgPerProject} |`,
    `| Organizations | ${(results.orgResults || []).length} |`,
  ];
  const serverTotal = sumDurations(results.serverSteps);
  if (serverTotal > 0) {
    lines.push(`| Server-Wide Extraction | ${formatDuration(serverTotal)} |`);
  }
  for (const org of (results.orgResults || [])) {
    if (org.durationMs != null) {
      lines.push(`| Org: ${org.key} (total) | ${formatDuration(org.durationMs)} |`);
    }
  }
  lines.push('');
  return lines.join('\n');
}

function formatServerSteps(results) {
  if (results.serverSteps.length === 0) return null;
  const lines = [
    '## Server-Wide Extraction\n',
    '| Step | Duration | Status |',
    '|------|----------|--------|',
  ];
  for (const step of results.serverSteps) {
    const dur = step.durationMs != null ? formatDuration(step.durationMs) : '—';
    lines.push(`| ${step.step} | ${dur} | ${step.status} |`);
  }
  const total = sumDurations(results.serverSteps);
  lines.push(`| **Total** | **${formatDuration(total)}** | |`);
  lines.push('');
  return lines.join('\n');
}

function formatOrgSteps(results) {
  if (!results.orgResults || results.orgResults.length === 0) return null;
  const sections = [];
  for (const org of results.orgResults) {
    const lines = [`## Organization: ${org.key}\n`];
    if (org.durationMs != null) {
      lines.push(`**Total org migration time:** ${formatDuration(org.durationMs)}\n`);
    }
    if (org.steps && org.steps.length > 0) {
      lines.push('| Step | Duration | Status | Detail |');
      lines.push('|------|----------|--------|--------|');
      for (const step of org.steps) {
        const dur = step.durationMs != null ? formatDuration(step.durationMs) : '—';
        const detail = step.detail || step.error || '';
        lines.push(`| ${step.step} | ${dur} | ${step.status} | ${detail} |`);
      }
      const total = sumDurations(org.steps);
      lines.push(`| **Total (org steps)** | **${formatDuration(total)}** | | |`);
    }
    lines.push('');
    sections.push(lines.join('\n'));
  }
  return sections.join('\n');
}

function formatProjectBreakdown(results) {
  if (results.projects.length === 0) return null;
  const sorted = [...results.projects].sort((a, b) => (b.durationMs || 0) - (a.durationMs || 0));
  const lines = [
    '## Per-Project Breakdown\n',
    'Sorted by total duration (slowest first).\n',
    '| # | Project | Total | Report Upload | Issue Sync | Hotspot Sync | Config |',
    '|---|---------|-------|---------------|------------|--------------|--------|',
  ];
  sorted.forEach((project, i) => {
    const total = project.durationMs != null ? formatDuration(project.durationMs) : '—';
    const reportUpload = getStepDuration(project, 'Upload scanner report');
    const issueSync = getStepDuration(project, 'Sync issues');
    const hotspotSync = getStepDuration(project, 'Sync hotspots');
    const configDur = getConfigDuration(project);
    lines.push(`| ${i + 1} | \`${project.projectKey}\` | ${total} | ${reportUpload} | ${issueSync} | ${hotspotSync} | ${configDur} |`);
  });
  lines.push('');
  return lines.join('\n');
}
